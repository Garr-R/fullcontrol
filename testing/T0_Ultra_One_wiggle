import fullcontrol as fc
from math import tau, sin

# Filament specific settings:
# PLA is nearly finished  :D
PLA_filament_settings = {
    'filament_hotend_temp': 215,
    'filament_bed_temp': 60,
    'filament_fan_percent': 100,
    'filament_print_speed_percent': 1000,
    'filament_material_flow_percent': 100
}

# PETG hasn't been tested
PETG_filament_settings = {
    'filament_hotend_temp': 245,
    'filament_bed_temp': 75,
    'filament_fan_percent': 100,
    'filament_print_speed_percent': 1000,
    'filament_material_flow_percent': 100
}

# ABS hasn't been tested
ABS_filament_settings = {
    'filament_hotend_temp': 250,
    'filament_bed_temp': 110,
    'filament_fan_percent': 0,
    'filament_print_speed_percent': 1000,
    'filament_material_flow_percent': 100
}

# Cheating because ASA is basically ABS
ASA_filament_settings = ABS_filament_settings

# TPU hasn't been tested
TPU_filament_settings = {
    'filament_hotend_temp': 250,
    'filament_bed_temp': 110,
    'filament_fan_percent': 0,
    'filament_print_speed_percent': 1000,
    'filament_material_flow_percent': 100
}
# NYLON hasn't been tested
NYLON_filament_settings = {
    'filament_hotend_temp': 250,
    'filament_bed_temp': 110,
    'filament_fan_percent': 0,
    'filament_print_speed_percent': 1000,
    'filament_material_flow_percent': 100
}



# Nozzle specific settings:
nozzle_0_25mm_settings = {
    'nozzle_extrusion_width': 0.3,
}
nozzle_0_35mm_settings = {
    'nozzle_extrusion_width': 0.42
}
nozzle_0_50mm_settings = {
    'nozzle_extrusion_width': 0.6
}
nozzle_0_75mm_settings = {
    'nozzle_extrusion_width': 0.84
}



def main():

    # Define the filament and nozzle settings to use:
    selected_filament = ASA_filament_settings # PETG_filament_settings / ABS_filament_settings
    selected_nozzle = nozzle_0_50mm_settings # nozzle_0_25mm_settings / nozzle_0_35mm_settings / nozzle_0_50mm_settings / nozzle_0_75mm_settings

    # Custom parameters for PLA wiggle test on Ultra One Rev.0 and Rev.1
    print_settings = {
        'primer': 'front_lines_then_xy',
        'extrusion_width': selected_nozzle['nozzle_extrusion_width'],
        'print_speed_percent': selected_filament['filament_print_speed_percent'],
        'material_flow_percent': selected_filament['filament_material_flow_percent'],
        'nozzle_temp': selected_filament['filament_hotend_temp'],
        'bed_temp': selected_filament['filament_bed_temp'],
        'fan_percent': selected_filament['filament_fan_percent'],
        'travel_speed': 18000 # Does this work for the M2 / M3 printers?
        }

    printer='t0_ultra_one' # generic / ultimaker2plus / prusa_i3 / ender_3 / cr_10 / bambulab_x1 / toolchanger_T0
    filename = 'fixed_wiggle_test' # filename without extension

    # Used in the original (javascript) wiggle script:
    #{% set xpos = parameters.wiggleX %}
    #{% set ypos = parameters.wiggleY %}
    #{% set zpos = parameters.wiggleHeight %}

    # design parameters
    Xaxis_movement = 20.0
    Yaxis_movement = selected_nozzle['nozzle_extrusion_width']
    #Yaxis_movement = 0.48

    # increase the increment TODO: This will need to be changed for different nozzle sizes (currently set for 0.5mm nozzle)
    Yaxis_movement_increment = 0.01

    # total number of loops (22 zig-zag lines)
    zig_zag_lines = 11

    # Ultra One center starting position
    Xaxis_pos = 203
    Yaxis_pos = 177
    Zaxis_pos = 0.2

    steps = []
    # wiggle starting position
    steps.append(fc.Point(x=Xaxis_pos, y=Yaxis_pos, z=Zaxis_pos, color=[0, 1, 0]))

    # Enable the extruder
    steps.append(fc.Extruder(on=True))

    # Loop through the zig-zag lines
    for x in range(zig_zag_lines):
        # Increment the Xaxis position
        Xaxis_pos = Xaxis_pos + Xaxis_movement
        print('new Xaxis_pos: ', Xaxis_pos)


        # Move 1
        steps.append(fc.Point(x=Xaxis_pos))

        # Increment the Yaxis position
        Yaxis_movement_increment += 0.01
        Yaxis_pos = Yaxis_pos + Yaxis_movement + Yaxis_movement_increment
        print('new Yaxis_pos: ', Yaxis_pos)



        # Move 2
        steps.append(fc.Point(y=Yaxis_pos, color=[1, 0, 0]))

        # Increment the Xaxis position
        Xaxis_pos = Xaxis_pos - Xaxis_movement
        print('new Xaxis_pos: ', Xaxis_pos)



        # Move 3
        steps.append(fc.Point(x=Xaxis_pos, y=Yaxis_pos, z=Zaxis_pos))
        print("loop: ", x)

        # Increment the Yaxis position
        Yaxis_movement_increment += 0.01
        Yaxis_pos = Yaxis_pos + Yaxis_movement + Yaxis_movement_increment
        print('new Yaxis_pos: ', Yaxis_pos)



        # Move 4
        steps.append(fc.Point(y=Yaxis_pos, color=[0, 0, 1]))

    # generate the gcode
    fc.transform(steps, 'gcode', fc.GcodeControls(printer_name=printer, save_as=filename, initialization_data=print_settings))

    # plot the steps
    #fc.transform(steps, 'plot', fc.PlotControls(color_type='manual', zoom=4))


if __name__ == "__main__":
    """ This is executed when run from the command line """
    main()